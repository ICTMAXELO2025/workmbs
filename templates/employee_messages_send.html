{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Send Message</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <a href="{{ url_for('employee_messages') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>Back to Messages
        </a>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <div class="dashboard-widget">
            <h5 class="mb-4"><i class="fas fa-paper-plane me-2 text-primary"></i>Compose New Message</h5>
            
            <form method="POST" enctype="multipart/form-data" id="messageForm">
                <div class="form-section">
                    <h6>Recipient</h6>
                    <div class="mb-3">
                        <label for="receiver_id" class="form-label">To <span class="text-danger">*</span></label>
                        <select class="form-select" id="receiver_id" name="receiver_id" required>
                            <option value="">Select Employee</option>
                            {% for employee in employees %}
                            <option value="{{ employee.id }}" 
                                    data-department="{{ employee.department }}"
                                    data-email="{{ employee.email }}">
                                {{ employee.name }} ({{ employee.department }})
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">Select the employee you want to message</div>
                    </div>

                    <!-- Recipient Info Display -->
                    <div id="recipientInfo" class="alert alert-info" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-user-circle me-3 fa-2x"></i>
                            <div>
                                <strong id="recipientName">-</strong>
                                <div class="small">
                                    <span id="recipientDepartment">-</span> â€¢ 
                                    <span id="recipientEmail">-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h6>Message Details</h6>
                    <div class="mb-3">
                        <label for="subject" class="form-label">Subject <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="subject" name="subject" 
                               placeholder="Enter message subject..." required>
                        <div class="form-text">Be specific about your message topic</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="content" class="form-label">Message <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="content" name="content" rows="8" 
                                  placeholder="Type your message here..." required></textarea>
                        <div class="form-text">Write clear and concise message</div>
                    </div>
                </div>

                <div class="form-section">
                    <h6>Attachments (Optional)</h6>
                    <div class="mb-3">
                        <label for="document" class="form-label">Add Attachment</label>
                        
                        <div class="file-upload-area" id="fileUploadArea">
                            <div class="text-center py-4">
                                <i class="fas fa-cloud-upload-alt fa-2x text-muted mb-3"></i>
                                <h5>Drag & Drop your file here</h5>
                                <p class="text-muted">or click to browse</p>
                                <small class="text-muted">Maximum file size: 16MB</small>
                            </div>
                            <input type="file" class="form-control d-none" id="document" name="document" 
                                   accept=".pdf,.doc,.docx,.txt,.jpg,.jpeg,.png,.gif,.xlsx,.xls,.pptx,.ppt,.csv">
                        </div>
                        
                        <div class="file-preview mt-3" id="filePreview" style="display: none;">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <i class="fas fa-file file-icon text-primary me-3"></i>
                                    <div>
                                        <div class="fw-bold" id="fileName">document.pdf</div>
                                        <small class="text-muted" id="fileSize">0 KB</small>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-sm btn-outline-danger" id="removeFile">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="form-text">
                            Supported formats: PDF, Word, Excel, PowerPoint, Images, Text files
                        </div>
                    </div>
                </div>

                <div class="form-section">
                    <h6>Message Options</h6>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="urgent" name="urgent">
                            <label class="form-check-label" for="urgent">
                                <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                                Mark as urgent
                            </label>
                        </div>
                        <div class="form-text">Urgent messages will be highlighted for the recipient</div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="request_receipt" name="request_receipt" checked>
                            <label class="form-check-label" for="request_receipt">
                                <i class="fas fa-receipt text-info me-1"></i>
                                Request read receipt
                            </label>
                        </div>
                        <div class="form-text">Get notified when the recipient reads your message</div>
                    </div>
                </div>

                <div class="mt-4 pt-3 border-top">
                    <button type="submit" class="btn btn-primary btn-lg" id="submitBtn">
                        <i class="fas fa-paper-plane me-2"></i>Send Message
                    </button>
                    <button type="button" class="btn btn-outline-secondary btn-lg" id="saveDraftBtn">
                        <i class="fas fa-save me-2"></i>Save Draft
                    </button>
                    <a href="{{ url_for('employee_messages') }}" class="btn btn-outline-danger btn-lg">Cancel</a>
                </div>
            </form>
        </div>
    </div>

    <div class="col-lg-4">
        <div class="dashboard-widget">
            <h6><i class="fas fa-info-circle me-2 text-info"></i>Sending Guidelines</h6>
            
            <div class="alert alert-info">
                <h6>Best Practices:</h6>
                <ul class="mb-0 small">
                    <li>Use clear and descriptive subject lines</li>
                    <li>Be professional and concise</li>
                    <li>Attach relevant documents when needed</li>
                    <li>Proofread before sending</li>
                </ul>
            </div>

            <div class="alert alert-warning">
                <h6>Privacy Notice:</h6>
                <ul class="mb-0 small">
                    <li>Messages are stored in the system</li>
                    <li>Only share work-related information</li>
                    <li>Avoid sensitive personal data</li>
                </ul>
            </div>

            <div class="quick-tips">
                <h6>Quick Tips:</h6>
                <div class="d-flex flex-wrap gap-2">
                    <span class="badge bg-primary">Professional</span>
                    <span class="badge bg-success">Clear</span>
                    <span class="badge bg-info">Concise</span>
                    <span class="badge bg-warning">Relevant</span>
                </div>
            </div>
        </div>

        <div class="dashboard-widget mt-4">
            <h6><i class="fas fa-history me-2 text-success"></i>Recent Contacts</h6>
            {% if recent_contacts %}
            <div class="list-group list-group-flush">
                {% for contact in recent_contacts %}
                <div class="list-group-item px-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1 small">{{ contact.name }}</h6>
                            <small class="text-muted">{{ contact.department }}</small>
                        </div>
                        <button type="button" class="btn btn-sm btn-outline-primary select-contact" 
                                data-employee-id="{{ contact.id }}"
                                data-employee-name="{{ contact.name }}"
                                data-employee-department="{{ contact.department }}"
                                data-employee-email="{{ contact.email }}">
                            Select
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted small">No recent contacts</p>
            {% endif %}
        </div>

        <div class="dashboard-widget mt-4">
            <h6><i class="fas fa-paperclip me-2 text-purple"></i>Attachment Tips</h6>
            <ul class="small mb-0">
                <li>Use common file formats</li>
                <li>Keep files under 16MB</li>
                <li>Rename files descriptively</li>
                <li>Compress large files if needed</li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const receiverSelect = document.getElementById('receiver_id');
    const recipientInfo = document.getElementById('recipientInfo');
    const recipientName = document.getElementById('recipientName');
    const recipientDepartment = document.getElementById('recipientDepartment');
    const recipientEmail = document.getElementById('recipientEmail');
    const fileUploadArea = document.getElementById('fileUploadArea');
    const fileInput = document.getElementById('document');
    const filePreview = document.getElementById('filePreview');
    const fileName = document.getElementById('fileName');
    const fileSize = document.getElementById('fileSize');
    const removeFileBtn = document.getElementById('removeFile');
    const submitBtn = document.getElementById('submitBtn');
    const saveDraftBtn = document.getElementById('saveDraftBtn');
    const form = document.getElementById('messageForm');

    // Recipient selection handler
    receiverSelect.addEventListener('change', function() {
        const selectedOption = this.options[this.selectedIndex];
        if (selectedOption.value) {
            recipientName.textContent = selectedOption.text.split(' (')[0];
            recipientDepartment.textContent = selectedOption.getAttribute('data-department');
            recipientEmail.textContent = selectedOption.getAttribute('data-email');
            recipientInfo.style.display = 'block';
        } else {
            recipientInfo.style.display = 'none';
        }
    });

    // Recent contact selection
    document.querySelectorAll('.select-contact').forEach(btn => {
        btn.addEventListener('click', function() {
            const employeeId = this.dataset.employeeId;
            const employeeName = this.dataset.employeeName;
            const employeeDepartment = this.dataset.employeeDepartment;
            const employeeEmail = this.dataset.employeeEmail;
            
            receiverSelect.value = employeeId;
            recipientName.textContent = employeeName;
            recipientDepartment.textContent = employeeDepartment;
            recipientEmail.textContent = employeeEmail;
            recipientInfo.style.display = 'block';
            
            showToast(`Selected ${employeeName} as recipient`, 'success');
        });
    });

    // File upload area click handler
    fileUploadArea.addEventListener('click', function() {
        fileInput.click();
    });

    // Drag and drop functionality
    fileUploadArea.addEventListener('dragover', function(e) {
        e.preventDefault();
        fileUploadArea.classList.add('dragover');
    });

    fileUploadArea.addEventListener('dragleave', function() {
        fileUploadArea.classList.remove('dragover');
    });

    fileUploadArea.addEventListener('drop', function(e) {
        e.preventDefault();
        fileUploadArea.classList.remove('dragover');
        
        if (e.dataTransfer.files.length) {
            fileInput.files = e.dataTransfer.files;
            handleFileSelection(e.dataTransfer.files[0]);
        }
    });

    // File input change handler
    fileInput.addEventListener('change', function(e) {
        if (this.files.length) {
            handleFileSelection(this.files[0]);
        }
    });

    // Remove file handler
    removeFileBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        fileInput.value = '';
        filePreview.style.display = 'none';
        fileUploadArea.style.display = 'block';
        showToast('File removed', 'info');
    });

    // Handle file selection
    function handleFileSelection(file) {
        if (file) {
            // Validate file size (16MB max)
            const maxSize = 16 * 1024 * 1024;
            if (file.size > maxSize) {
                showToast('File size must be less than 16MB', 'error');
                return;
            }

            // Validate file type
            const allowedTypes = ['pdf', 'doc', 'docx', 'txt', 'jpg', 'jpeg', 'png', 'gif', 'xlsx', 'xls', 'pptx', 'ppt', 'csv'];
            const fileExtension = file.name.split('.').pop().toLowerCase();
            
            if (!allowedTypes.includes(fileExtension)) {
                showToast('File type not allowed. Please check supported formats.', 'error');
                return;
            }

            // Update preview
            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            filePreview.style.display = 'block';
            fileUploadArea.style.display = 'none';

            showToast(`File "${file.name}" selected successfully`, 'success');
        }
    }

    // Save draft functionality
    saveDraftBtn.addEventListener('click', function() {
        const formData = {
            receiver_id: receiverSelect.value,
            subject: document.getElementById('subject').value,
            content: document.getElementById('content').value,
            urgent: document.getElementById('urgent').checked,
            request_receipt: document.getElementById('request_receipt').checked
        };
        
        localStorage.setItem('message_draft', JSON.stringify(formData));
        showToast('Draft saved successfully', 'success');
    });

    // Load draft if exists
    const savedDraft = localStorage.getItem('message_draft');
    if (savedDraft) {
        const draft = JSON.parse(savedDraft);
        receiverSelect.value = draft.receiver_id;
        document.getElementById('subject').value = draft.subject;
        document.getElementById('content').value = draft.content;
        document.getElementById('urgent').checked = draft.urgent;
        document.getElementById('request_receipt').checked = draft.request_receipt;
        
        // Trigger recipient info display if recipient is selected
        if (draft.receiver_id) {
            receiverSelect.dispatchEvent(new Event('change'));
        }
        
        showToast('Draft loaded from saved data', 'info');
    }

    // Form submission handler
    form.addEventListener('submit', function(e) {
        const receiverId = receiverSelect.value;
        const subject = document.getElementById('subject').value;
        const content = document.getElementById('content').value;

        if (!receiverId || !subject || !content) {
            e.preventDefault();
            showToast('Please fill in all required fields', 'error');
            return;
        }

        // Show loading state
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';

        // Clear draft on successful send
        localStorage.removeItem('message_draft');
    });

    // Character counter for message content
    const contentTextarea = document.getElementById('content');
    if (contentTextarea) {
        contentTextarea.addEventListener('input', function() {
            const charCount = this.value.length;
            const counter = this.parentNode.querySelector('.char-counter') || 
                           document.createElement('div');
            
            if (!counter.classList.contains('char-counter')) {
                counter.className = 'char-counter small text-muted mt-1';
                this.parentNode.appendChild(counter);
            }
            
            counter.textContent = `${charCount} characters`;
            
            if (charCount > 1000) {
                counter.classList.add('text-warning');
            } else {
                counter.classList.remove('text-warning');
            }
        });
    }

    // Auto-save draft every 30 seconds
    setInterval(() => {
        if (document.getElementById('subject').value || document.getElementById('content').value) {
            saveDraftBtn.click();
        }
    }, 30000);

    // File size formatter
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Toast notification function
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `alert alert-${type} alert-dismissible fade show toast-message`;
        toast.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        toast.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
        `;
        
        document.body.appendChild(toast);
        
        setTimeout(() => {
            if (toast.parentNode) {
                toast.remove();
            }
        }, 5000);
    }
});
</script>

<style>
.file-upload-area {
    border: 2px dashed #dee2e6;
    border-radius: 8px;
    padding: 20px;
    text-align: center;
    transition: all 0.3s;
    background: #fafafa;
    cursor: pointer;
}

.file-upload-area:hover {
    border-color: #3498db;
    background: #f0f8ff;
}

.file-upload-area.dragover {
    border-color: #27ae60;
    background: #f0fff4;
}

.file-preview {
    background: #f8f9fa;
    border-radius: 6px;
    padding: 15px;
    border-left: 4px solid #17a2b8;
}

.form-section {
    background: white;
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border-left: 4px solid #3498db;
}

.form-section h6 {
    color: #2c3e50;
    margin-bottom: 15px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e9ecef;
}

.select-contact {
    font-size: 0.75rem;
    padding: 2px 8px;
}

.char-counter.text-warning {
    font-weight: bold;
}

@media (max-width: 768px) {
    .form-section {
        padding: 15px 10px;
    }
    
    .file-upload-area {
        padding: 15px;
    }
}
</style>
{% endblock %}